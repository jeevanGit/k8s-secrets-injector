---
apiVersion: v1
kind: Pod
metadata:
  name: vault-agent
  labels:
    aadpodidbinding: pod-selector-label

spec:
  serviceAccountName: ${SERVICEACCOUNT}
  restartPolicy: Always
  volumes:
    - name: vault-token
      emptyDir:
        medium: Memory
    - name: config
      configMap:
        name: vault-agent-config
        items:
          - key: vault-agent-config.hcl
            path: vault-agent-config.hcl
          - key: consul-template-config.hcl
            path: consul-template-config.hcl
    - name: shared-data
      emptyDir: {}

  containers:
    - name: vault-agent-auth
      image: vault
      args:
        [
          "agent",
          "-config=/etc/vault/vault-agent-config.hcl",
          "-log-level=debug",
        ]
      env:
        - name: VAULT_ADDR
          value: http://23.99.212.238:8200

      volumeMounts:
        - name: config
          mountPath: /etc/vault
        - name: vault-token
          mountPath: /home/vault
        - name: shared-data
          mountPath: /etc/secrets

    - name: injector
      image: securityopregistrytest.azurecr.io/secret-injector:v1alpha4
      imagePullPolicy: Always
      env:
        - name: hashicorpvault
          value: http://23.99.212.238:8200
        - name: VAULT_ROLE
          value: ${VAULT_ROLE}
        - name: SERVICEACCOUNT
          value: ${SERVICEACCOUNT}
        - name: MYSQL_CREDS
          value: secret/${APP_NAME}/${NAMESPACE}/mysql@hashicorpvault
        - name: MYDB2_CREDS
          value: secret/${APP_NAME}/${NAMESPACE}/mysql@hashicorpvault

        - name: VAULT_TOKEN_PATH
          value: "/home/vault/.vault-token"
        - name: VAULT_REAUTH
          value: "true"
        - name: VAULT_AUTH_MOUNT_PATH
          value: "kubernetes"
        - name: SERVICE_ACCOUNT_TOKEN_PATH
          value: "/var/run/secrets/kubernetes.io/serviceaccount/token"

        - name: debug
          value: "true"
        - name: VAULT_SKIP_VERIFY
          value: "true"

      volumeMounts:
        - name: vault-token
          mountPath: /home/vault
        - name: shared-data
          mountPath: /etc/secrets
