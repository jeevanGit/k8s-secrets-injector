---
apiVersion: v1
kind: Pod
metadata:
  name: vault-agent
  labels:
    aadpodidbinding: pod-selector-label

spec:
  serviceAccountName: ${SERVICEACCOUNT}
  restartPolicy: Always
  volumes:
    - name: vault-token
      emptyDir:
        medium: Memory
    - name: shared-data
      emptyDir: {}

  containers:
    - name: injector
      image: securityopregistrytest.azurecr.io/secret-injector:v1alpha5
      imagePullPolicy: Always
      env:
        - name: hashicorpvault
          value: ${HC_IP}
        - name: VAULT_ROLE
          value: ${VAULT_ROLE}
        - name: SERVICEACCOUNT
          value: ${SERVICEACCOUNT}
        - name: VAULT_PATH
          value: "appCodes/aeo0/sample-express-backend/dev/"

        - name: MYSQL_CREDS
          value: secret/${APP_NAME}/${NAMESPACE}/db2@hashicorpvault
        - name: MYDB2_CREDS
          value: secret/${APP_NAME}/${NAMESPACE}/mysql@hashicorpvault
        - name: SECRET_INJECTOR_SECRET_NAME_1
          value: mysql_creds
        - name: SECRET_INJECTOR_MOUNT_PATH_1
          value: /etc/secrets
        - name: SECRET_STORE_SYSTEM_1
          value: hashicorpvault
        - name: SECRET_INJECTOR_SECRET_NAME_2
          value: db2_creds
        - name: SECRET_INJECTOR_MOUNT_PATH_2
          value: /etc/secrets
        - name: SECRET_STORE_SYSTEM_2
          value: hashicorpvault

        - name: AzureKeyVault
          value: aks-AC0001-keyvault

        - name: db2_password
          value: "db2password@AzureKeyVault"
        - name: SECRET_INJECTOR_SECRET_NAME_3
          value: db2password
        - name: SECRET_INJECTOR_MOUNT_PATH_3
          value: /etc/secrets
        - name: SECRET_STORE_SYSTEM_3
          value: AzureKeyVault

        - name: debug
          value: "true"


      volumeMounts:
        - name: vault-token
          mountPath: /azure-keyvault
        - name: shared-data
          mountPath: /etc/secrets
